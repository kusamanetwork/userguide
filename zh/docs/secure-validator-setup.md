# 设定安全的验证人節點

在过去一年里面我们开始看到有不同项目开始从 PoW 转向 PoS，从而创造了一个通过提供抵押服务的全新业务。在某种意义上，运行验证人其实跟交易所差不多，因为其验证人背后可能有价值数百万的资产在抵押中，所以作为验证人，你必须保持提高验证人节点的安全级别并且拥有一个强大的网络架构使抵押中的资产不会有损失的风险。

构建网络架构的方法有很多种，运行验证人的目标是不被惩罚，而最常被惩罚情况的二种情况是伺服务离线和双重签名。实现这些目标所花费的精力取决于你需要的安全级别，如果验证人背后只有数千元在抵押当然不会跟一个背后拥有数百万在抵押中的验证人架构一样，所以鼓励大家拥有自己的架构设计，以避免跟其他验证人一样被黑客因相同漏洞而入侵。

话虽如此，有一些常见的技巧对任何有兴趣运行验证人节点的人也有用。事不宜迟，我们将首先介绍一些现有的验证人架构设计，然后再分别研究每个不同的区域。

### 现有方式 (Cosmos, Tezos, etc)

我们将会在本节集中网络架构的设计，无论你在运行那个网络的验证人，它们都会有类似的网络设计，所以我们将会用 Cosmos 作参考。

最简单方式是验证人节点没有设置任何防火墙保护，任何人也可以通过 P2P 端口连接，这意味着任何人也会得知道你节点的 IP 地址，这是不理想的，并打开其他攻击媒介。

第二个方式是在验证人前方加上防火墙，这意味着它可以借着防火墙进行深度封包检测，这可以防止攻击例如SYN-洪水，但是它的缺点是
验证人是有机会离线，因此，当节点出现中断或无法访问时，它可能导致验证人被惩罚。另一个问题是它没有（DoS）的阻力，这意味着它很容易以这种方式受到攻击。在[这里](#分层网络架构)阅读有关分层网络架构的更多信息。


不幸的是，这个设计还有可靠性问题，就是当验验人一旦发生故障。可以通过部署另外一个验证人来支持[高可靠性](#高可靠性-(任选))功能来避免这种情况。这样即使当验证人离线，仍然有备用验证人能换上，从而避免潜在没回应的惩罚。当然如果主要和备用验证人也没有反应，最终也会被惩罚，因此你主要和备用验证人应至少在地理上分开，但是你可以改变其他方面(例如操作系统，硬件，服务提供商)去保证二台验证人节点不会同时出现问题。

除了这些架构决策，有一些方法可以改善密钥管理，使其无法对验证人服务器进行潜在入侵。这些方法包括使用硬件安全模块(Hardware Security Module)(请查看[此处](https://cosmos.network/docs/cosmos-hub/validators/validator-faq.html#technical-requirements) Cosmos 提供支持 ed25519 的HSM资料)。Cosmos还提供了密钥管理系统（KMS），它具有统一的API，支持从 HSM 等不同来源管理密钥的验证人，并具有双重签名保护。建议在另一台电脑上托管KMS，以便有更好安全性和风险管理，这会确保系统不会有单点故障。请记住验证人需要24/7小时在线上以被避免惩罚，这意味着恶意用户可以随时攻击验证人节点！

这里有一篇好文章关于[Cosmos Hub 架构](https://iqlusion.blog/a-look-inside-our-validator-architecture)，由 Tony Arcieri 和 Shella Stephens 撰写。

### 分层网络架构

在 [Cosmos 论坛](https://forum.cosmos.network/t/sentry-node-architecture-overview/454)的帖子中讨论了分层网络架构的概念，目的是通过在不同的云端服务器上运行多个公开全节点来减轻 DDoS 攻击的影响，并且只允许使这些节点与验证人通信。验证人本身设置于在防火墙或专用网络后面。

公开 "哨兵" 节点可以部署在云端服务器上运行，它们不会有任何风险，一旦它们停止运作一段时间，它们可以很快被更换，而不会对验证人的工作造成任何干扰。把节点部署到不同的 服务器商/不同地域中 运行也是有趣的，这样验证人不会受到任何一个服务器商中断的影响。话虽如此，还是有其他解决方案来减轻 DDoS 攻击，我们鼓励大家建立自己的设计，以避免大家被同一方式入侵。

### 高可靠性 (任选)

验证人节点必须24/7运行，尽可能接近 100％ 没有离线。如果验证人不能连接，这样会导致验证人部份抵押中的资产被惩罚。

通过设立高可靠性，验证人节点会比单一节点更强大，即使其中一个验证人节点不能连接，仍然有另一台验证人能参与验证过程。

以下是高可靠性设置的两个例子：

#### 主 (Active) - 备用 (Standby)

试想像有二个验证人，一台是主而另一台是备用(容错)。我们可以监察主节点，一旦发生问题，备用会将立即接管。二台节点也需要确保以相同的方式配置。无论你在主要的节点中更改了什么，另外一个也必须相同。
 
#### 主 (Active) - 主 (Active)

试想像增加一个负载均衡(Load Balancer)在中间作连接二台验证人节点，之后通过算法决定那个验证人负责处理。它可能使用循环算法或者其它，但是它需要确保不会发生双重签名，因为二台节点正在同时间使用同一条密钥。

这里任何一种方式都是有效，选择那一个完全取决于你想要达到什么效果。

### 硬件安全模块

HSM 是硬件组件储存你的密钥在防篡改的安全元素里面，永不会在签名期间在档案系统里暴露密钥，这使得攻击者极难提取私钥。如果验证人储存密钥在同一台电脑内并且是纯文本格式，那么当验证人被黑客入侵时，你的密钥将会很容易被暴露。此时，攻击者能通过双重签名导致验证人抵押中的资产被惩罚，所以找专用于储存密钥的硬件组件是非常重要。

现时市场上有不同类型的 HSM，因为 [YubiHSM2](https://www.yubico.com/products/yubihsm/) 支持 Ed25519 曲线算法，所以是 Cosmos 验证人中使用最广泛的。验证人也可以使用
云端 HSM 例如 [AWS](https://aws.amazon.com/cloudhsm/?nc1=h_ls) 或 [GCP](https://cloud.google.com/hsm/?hl=en) 来储存密钥。但是，在选择云端 HSM 之前，你应该查看一下它们是否支持你需要的签名。例如，在编写这篇文章时，由于 Ed25519 曲线算法比较新，所以只有微软 Azure 中的云端 HSM 支持。

话虽如此，验证人管理着数百万元的资产，所以绝对不建议储存密钥在云端 HSM。当你使用云端 HSM，你只能相信方案提供商，因此，当你决定使用云端 HSM 设置验证人时，请考虑你对方案提供商的信任程度。

此外，与 YubiHSM2 相比，Azure 的每月费用超过 $3,000 美元，则相对昂贵。

另一种方法是使用自定义远程签名服务器，提供了同样的安全性。通过这个设置，有一台独立的服务器，专门负责执行签名。

如果想证实你的验证人网络结构和设置是否安全，还可以让第三方审核你的设置并发布结果。

### 监测工具

- [Telemetry](https://github.com/paritytech/substrate-telemetry) - 这将跟踪验证人节点的详细信息，包括正在运行的版本，区块高度，CPU 和内存使用情况，区块传播时间等等

- 基于[Prometheus](https://prometheus.io/)的监控堆栈，包括用于仪表板和日志聚合的 Grafana。它提供警报，查询，可视化和监控功能，适用于云端和本地系统。数据来自 substrate-telemetry 可以通过这样方式汇出给 prometheus。



### Linux 最佳实践

- 不要使用 root 使用者
- 保持时常更新操作系统安全包
- 启动和设置防火墙
- 不允许输入密码方式登入 SSH，只容许公开金钥认证
- 关闭 SSH 非必要的子系统（banner，motd，scp，X11 forwarding）并加强ssh配置（[比较充足的手册](https://stribika.github.io/2015/01/04/secure-secure-shell.html)）
- 定期备份储存

## 结论和提议

* 验证人不应直接面向网络，反而只能供允许的地址连接，因此，我们提出分层方法，把验证人与互联网隔离，并通过中间层的公开的哨兵节点连接到波卡网络。

* 现时 Polkadot/Substrate 不能与 HSM/SGX 互动，所以我们需要把签名密钥种子放在验证人节点上。该密钥是保留在节点内存中的生命周期。

* 鉴于高可靠性设置总是存在双重签名的风险，并且目前没有内置机制来阻止，我们建议使用单个验证人来避免惩罚。 离线惩罚的处罚远远低于双重签名。



### 驗証人

* 通过二进制方式运行 Polkadot/Substrate，并且除了 P2P 设置的通讯端口，其它不应打开。


* 只在 bare-metal 上运行，而不是虚拟机。这防止云端服务器的一些可靠性问题，以及来自同一硬件上其他虚拟机的潜在攻击。验证人的配置应该是自动化并且在代码中定义。该代码应保存在私有版本控制，审核和经测试。

* 签名和节点的密钥应以安全的方式提供 [进行中: 通过 RPC 转换 Session 密钥]

* 如果 Polkadot / Substrate 有任何问题而停止，应该在开机和重新启动后自动运行(Supervisor管理程序）。

* Polkadot / Substrate 不应使用超级用户(root)

* 每个验证人至少通过二个公开节点连接(通过设置 `--reserved-nodes`)到 Polkadot 网络。连接是通过VPN并且该电脑不能连接到互联网，所以只有通过VPN才能连接。

### 公开哨兵节点

* 每个验证人至少有两个节点在不同的云端服务器上运行，并且仅公开 P2P 端口。

* 节点应以安全的方式提供密钥。

* 仅运行 Substrate 容器，无需其他服务。VPN 代理应该在同一个 pod 中的 sidecar 上运行（共享相同的网络堆栈）

### 监察

* 监察公开节点和验证人及定义故障的警报

* 为管理警报定义了一个随传随到的轮换

* 有一个明确的运行手册，其中包含针对每个警报和升级策略级别执行的操作。

## 参考

https://medium.com/figment-networks/full-disclosure-figments-cosmos-validator-infrastructure-3bc707283967

https://kb.certus.one/

https://github.com/slowmist/eos-bp-nodes-security-checklist

https://forum.cosmos.network/t/sentry-node-architecture-overview/454

https://medium.com/loom-network/hsm-policies-and-the-importance-of-validator-security-ec8a4cc1b6f